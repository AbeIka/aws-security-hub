# AWS Security Hub Integration

aws configure add-model --service-model file://securityhub-2018-10-26.normal.json --service-name securityhub

AWS Security Hub provides a comprehensive view of your high priority security alerts and compliance status for your AWS deployment. By combining data from [Amazon GuardDuty](https://aws.amazon.com/guardduty/), [Amazon Inspector](https://aws.amazon.com/inspector/), and [Amazon Macie](https://aws.amazon.com/macie/) along with a host of [APN partner solutions](https://aws.amazon.com/security/partner-solutions/), the AWS Security Hub is a one-stop shop for security visibility.

Each data source provides various findings relevant to the tool. Amazon Macie will send findings related to data within Amazon S3 buckets it monitors, Amazon GuardDuty will provide findings based on the assessments it runs on your Amazon EC2 Instances, and so forth.

This repository contains the code required to supply data from **your** Deep Security install to AWS Security Hub.

## Design

...

## Deployment

### Configure Deep Security To Send Events To Amazon SNS

The configuration to send all Deep Security events to Amazon SNS is very simple. It's [detailed here](https://help.deepsecurity.trendmicro.com/sns.html) in the Deep Security Help Center. In lieu of copying those steps here, please refer to the Help Center, that will always be up to date.

By default, this configuration sends all Deep Security events to the specified Amazon SNS topic. You can [filter what events are sent](https://help.deepsecurity.trendmicro.com/Events-Alerts/sns-json-config.html?Highlight=sns) using a simple JSON policy language (very similar to AWS IAM).

This integration only uses a subset of Deep Security events. Essentially only sending critical and high severity events to AWS Security Hub by default. This class of events is more closely related to the core concept of an AWS Security Hub finding.

**Caution:** if you use the Deep Security event policy language to prevent relevant events from being sent to an Amazon SNS topic, those events won't show up in the AWS Security Hub. This is unlikely to happen but something to be aware of if you're filtering the event stream outbound from your Deep Security installation.

### Configure AWS Security Hub

...

### Configure The AWS Lambda Function

Using the CloudFormation template in this repository, you can easily deploy the required AWS Lambda function and assign the proper permissions via the AWS IAM execution role.

The code requires the following permissions to run;

- read access to the target Amazon SNS topic that Deep Security is sending events to
- write access to the AWS Security Hub API, specifically the ImportFindings function calls

## Findings

Deep Security uses the following core event types:

- *SystemEvent* - Generated by Deep Security as a platform. Includes events like agent updates, communication issues, etc.
- *PacketLog* - Generated by the firewall control. Possible events include, packet denied, communication permitted, and others
- *PayloadLog* - Generated by the intrusion prevention control. Includes events like malicious payload found, generic attempt detection, communications dropped, and others
- *AntiMalwareEvent* - Generated by the anti-malware control. Possible events include, detection, quarantine of malware, and others
- *WebReputationEvent* - Generated by the web reputation control. This checks outgoing HTTP requests against known bad URLs. Possible events include a malicious URL requested, possible data exfiltration, and others
- *IntegrityEvent* - Generated by the integrity monitoring control. Possible events include folder modification, file write, and others
- *LogInspectionEvent* - Generated by the log inspection control. Possible events include brute force login attempt, password changes, and others
- *AppControlEvent* - Generated by the application control control. Possibl eevents application launch prevented, signature updated due to new deployment, and others

Each of these event types has different properties that contain details relevant to the event type. AppControlEvent's contain information about the application execution lifecycle. AntiMalwareEvents contain information that details the malware detected. And so on.

There are common identifying properties for all event types (Deep Security TenantID, timestamp, etc.) and some similarities even if the structure is a bit different.

In order to properly select events to send to the AWS Security Hub, this integration uses the following logic;

- *Severity* for intrusion prevention and integrity monitoring events. This property uses a simple scale of 1—4 with 4 being "critical". Events that are a 3 or a 4 are automatically sent to AWS Security Hub
- *Risk* for web reputation events. Any event tagged as a 3 (suspicious) or 4 (dangerous) will automatically be sent to AWS Security Hub
- *OSSEC_Level* for log inspection events. This property uses a range of 0—15 to indicate severity. Any event flagged between 8—15 (high to critical) will be sent to AWS Security Hub
- *InfectedFilePath* is used in anti-malware events. When present, this indicates the engine has detected malware in the file and taken an action. Any event with this property present will be forwarded to AWS Security Hub
- *RepeatCount* is used in firewall events. In order to /reduce/ the volume of firewall events sent upstream, this property is used to select events when the count is higher than 5

| This is the first level integration. As the AWS Security Hub evolves, more events will be sent upstream in order to help optimize the user experience.